<!-- ui.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FigmaJumpBack</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; overflow: hidden;
      font-family: sans-serif;
    }
    body {
      display: flex; flex-direction: column;
      padding: 8px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px;
    }
    .title {
      font-size: 16px; color: rgba(0,0,0,0.5); margin: 0;
    }
    .controls button {
      all: unset; margin-left: 8px;
      cursor: pointer; font-size: 16px; padding: 4px;
    }
    .controls button:hover {
      background: #f0f0f0; border-radius: 4px;
    }

    #historyList {
      flex: 1;
      list-style: none; padding: 0; margin: 0;
      overflow-y: auto; overflow-x: hidden;
    }
    li { margin-bottom: 4px; }

    button.entry {
      all: unset; display: flex; align-items: flex-start;
      position: relative;
      width: 100%; /* full width of 320px - padding */
      padding: 4px 6px;
      border: 1px solid #ccc; border-radius: 4px;
      cursor: pointer; overflow: hidden;
    }
    button.entry:hover { background: #f0f0f0; }

    .entry-icon { flex: 0 0 20px; margin-right: 6px; }
    .entry-content { flex: 1; overflow: hidden; }
    .entry-page {
      font-size: 12px; font-weight: bold; margin: 0 0 2px;
      white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
    }
    .entry-frame {
      font-size: 14px; margin: 0;
      white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
    }
    .remove-btn {
      display: none; position: absolute;
      top: 4px; right: 6px;
      all: unset; cursor: pointer; font-size: 14px; color: #999;
    }
    button.entry:hover .remove-btn {
      display: block;
    }

    /* resize handle */
    #resizeHandle {
      height: 6px; cursor: ns-resize;
      background: transparent;
      position: absolute; bottom: 0; left: 0; right: 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 class="title">Recent</h2>
    <div class="controls">
      <button id="lockBtn" title="Lock/Unlock history">ðŸ”“</button>
      <button id="clearBtn" title="Clear history">ðŸ§¹</button>
    </div>
  </div>
  <ul id="historyList">
    <li><i>Loadingâ€¦</i></li>
  </ul>
  <div id="resizeHandle"></div>

  <script>
    const CDN = "https://owlson.github.io/FigmaJumpBack/assets/icons";
    const ICON_URLS = {
      COMPONENT: `${CDN}/component.svg`,
      INSTANCE:  `${CDN}/instance.svg`,
      GROUP:     `${CDN}/group.svg`,
      FRAME:     `${CDN}/frame.svg`,
      SECTION:   `${CDN}/section.svg`,
      PAGE:      `${CDN}/page.svg`,
      IMAGE:     `${CDN}/image.svg`,
      VECTOR:    `${CDN}/vector.svg`,
      TEXT:      `${CDN}/text.svg`,
      DEFAULT:   `${CDN}/default.svg`
    };

    let locked = false;
    function getIconImg(type) {
      const url = ICON_URLS[type] || ICON_URLS.DEFAULT;
      return `<img class="entry-icon" src="${url}" width="20" height="20" alt="${type}">`;
    }
    function navigate(i) {
      parent.postMessage({ pluginMessage: { type: 'navigateTo', index: i } }, '*');
    }
    function removeEntry(i) {
      parent.postMessage({ pluginMessage: { type: 'removeEntry', index: i } }, '*');
    }
    function toggleLock() {
      locked = !locked;
      lockBtn.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
      parent.postMessage({ pluginMessage: { type: 'toggleLock', locked } }, '*');
    }

    // resize logic
    const handle = document.getElementById('resizeHandle');
    let isResizing = false, startY=0, startH=0;
    handle.addEventListener('mousedown', e => {
      isResizing = true;
      startY = e.clientY;
      startH = window.innerHeight;
    });
    window.addEventListener('mousemove', e => {
      if (!isResizing) return;
      const newH = startH + (e.clientY - startY);
      parent.postMessage({ pluginMessage: { type: 'resize', height: newH } }, '*');
    });
    window.addEventListener('mouseup', () => { isResizing = false; });

    window.onload = () => {
      parent.postMessage({ pluginMessage: { type: 'getHistory' } }, '*');
      parent.postMessage({ pluginMessage: { type: 'getLockState' } }, '*');
    };

    // handle incoming messages
    window.onmessage = e => {
      const msg = e.data.pluginMessage;
      if (msg.type === 'history') {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (!msg.history.length) {
          list.innerHTML = '<li><i>History is empty.</i></li>';
          return;
        }
        msg.history.forEach((entry, idx) => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.className = 'entry';
          btn.innerHTML =
            getIconImg(entry.nodeType) +
            `<div class="entry-content">
               <p class="entry-page">${entry.pageName}</p>
               <p class="entry-frame">${entry.nodeName || ''}</p>
             </div>` +
            `<button class="remove-btn" title="Remove">&times;</button>`;
          btn.onclick = () => navigate(idx);
          const r = btn.querySelector('.remove-btn');
          r.addEventListener('click', e => { e.stopPropagation(); removeEntry(idx); });
          li.appendChild(btn);
          list.appendChild(li);
        });
      }
      else if (msg.type === 'lockState') {
        locked = msg.locked;
        lockBtn.textContent = locked ? 'ðŸ”’' : 'ðŸ”“';
      }
    };

    const lockBtn = document.getElementById('lockBtn');
    lockBtn.addEventListener('click', toggleLock);
    document.getElementById('clearBtn').onclick = () =>
      parent.postMessage({ pluginMessage: { type: 'clearHistory' } }, '*');
  </script>
</body>
</html>

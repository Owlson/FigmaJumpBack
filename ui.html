<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FigmaJumpBack</title>
  <style>
    /* --- стили опущены для краткости; скопируй их из предыдущей версии --- */
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo-icon" data-icon="logo"></div>
      <div class="logo-text">FigmaJumpBack</div>
    </div>
    <div class="header-right">
      <!-- заменили <img> на <div> -->
      <div id="lockBtn" data-icon="lock-closed" title="Lock history"></div>
      <div id="clearBtn" data-icon="clear" title="Clear history"></div>
    </div>
  </div>

  <!-- SUBHEADER -->
  <div class="subheader">
    <div>Recent</div>
  </div>

  <!-- HISTORY LIST -->
  <ul id="historyList">
    <li><i>Loading…</i></li>
  </ul>

  <!-- RESIZE HANDLE -->
  <div id="resizeHandle"></div>

  <script>
    const CDN = "https://owlson.github.io/FigmaJumpBack/assets/icons";
    const ICON_URLS = {
      logo:        `${CDN}/logo.svg`,
      "lock-closed": `${CDN}/lock-closed.svg`,
      "lock-open":   `${CDN}/lock-open.svg`,
      clear:       `${CDN}/clear.svg`,
      frame:       `${CDN}/frame.svg`,
      page:        `${CDN}/page.svg`,
      instance:    `${CDN}/instance.svg`,
      image:       `${CDN}/image.svg`,
      vector:      `${CDN}/vector.svg`,
      component:   `${CDN}/component.svg`,
      default:     `${CDN}/default.svg`
    };

    /** 
     * Заменяет любой элемент с data-icon (включая его самого) на <img>
     * или задаёт src, если уже <img>
     */
    function loadIcons(root = document) {
      const nodes = [];
      // если сам root имеет data-icon
      if (root.hasAttribute && root.hasAttribute('data-icon')) {
        nodes.push(root);
      }
      // плюс все вложенные
      root.querySelectorAll('[data-icon]').forEach(el => nodes.push(el));

      nodes.forEach(el => {
        const key = el.getAttribute('data-icon');
        const url = ICON_URLS[key] || ICON_URLS.default;
        if (el.tagName.toLowerCase() === 'img') {
          el.src = url;
        } else {
          const img = document.createElement('img');
          img.src = url;
          img.width = el.clientWidth;
          img.height = el.clientHeight;
          img.alt = key;
          img.title = el.title || key;
          el.replaceWith(img);
        }
      });
    }

    function send(type, payload = {}) {
      parent.postMessage({ pluginMessage: { type, ...payload } }, '*');
    }

    // навигация
    function navigate(i) { send('navigateTo', { index: i }); }
    function removeEntry(i) { send('removeEntry', { index: i }); }
    function toggleLock() { send('toggleLock', { locked: !locked }); }

    // resize
    const handle = document.getElementById('resizeHandle');
    let isResizing=false, startY, startH;
    handle.addEventListener('mousedown', e => {
      isResizing = true; startY = e.clientY; startH = window.innerHeight;
    });
    window.addEventListener('mousemove', e => {
      if (!isResizing) return;
      send('resize', { height: startH + (e.clientY - startY) });
    });
    window.addEventListener('mouseup', () => { isResizing = false; });

    let locked = false;
    const lockBtn = document.getElementById('lockBtn');
    const clearBtn = document.getElementById('clearBtn');

    window.onload = () => {
      // подгрузим замены для header-кнопок
      loadIcons();
      // запросим историю и состояние lock
      send('getHistory');
      send('getLockState');
    };

    window.onmessage = e => {
      const msg = e.data.pluginMessage;
      if (msg.type === 'history') {
        const ul = document.getElementById('historyList');
        ul.innerHTML = '';
        if (!msg.history.length) {
          ul.innerHTML = '<li><i>History is empty.</i></li>';
        } else {
          msg.history.forEach((entry, idx) => {
            const li = document.createElement('li');
            const btn = document.createElement('div');
            btn.className = 'entry';
            btn.innerHTML = `
              <div class="entry-left">
                <div class="entry-icon" data-icon="${entry.nodeType.toLowerCase()}"></div>
                <div class="entry-text">
                  <div class="entry-title">${entry.pageName}</div>
                  ${entry.nodeName?`<div class="entry-subtitle">${entry.nodeName}</div>`:''}
                </div>
              </div>
              <div class="entry-remove" data-icon="clear"></div>`;
            loadIcons(btn);
            btn.addEventListener('click', () => navigate(idx));
            btn.querySelector('.entry-remove')
               .addEventListener('click', e => { e.stopPropagation(); removeEntry(idx); });
            ul.appendChild(li).appendChild(btn);
          });
        }
      }
      else if (msg.type === 'lockState') {
        locked = msg.locked;
        lockBtn.setAttribute('data-icon', locked ? 'lock-open' : 'lock-closed');
        lockBtn.title = locked ? 'Unlock history' : 'Lock history';
        loadIcons(lockBtn);
      }
    };

    lockBtn.addEventListener('click', () => {
      locked = !locked;
      toggleLock();
    });
    clearBtn.addEventListener('click', () => send('clearHistory'));
  </script>
</body>
</html>

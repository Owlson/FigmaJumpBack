<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>FigmaJumpBack</title>
  <style>
    :root {
      --blue: #83ACFF;
      --blue-05: rgba(131,172,255,0.05);
      --blue-15: rgba(131,172,255,0.15);
      --stroke: #E6E6E6;
      --text: #1F1F1F;
      --muted: #808080;
      --bg: #FFFFFF;
      --item-h: 40px;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    body { display: flex; flex-direction: column; }

    /* header */
    .subheader {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--stroke);
      user-select: none;
    }
    .label { font-size: 12px; color: var(--muted); letter-spacing: .04em; text-transform: uppercase; }
    .controls { display: flex; align-items: center; gap: 8px; }
    .icon-btn {
      width: 20px; height: 20px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 6px; cursor: pointer; opacity: .85;
    }
    .icon-btn:hover { background: var(--blue-05); }
    .icon-btn[aria-pressed="true"] { outline: 1px solid var(--blue); }

    /* list */
    .list { flex: 1 1 auto; overflow: auto; padding: 8px; padding-bottom: 0; }
    .item {
      display: grid; grid-template-columns: 24px 1fr 24px;
      align-items: center; gap: 8px;
      height: auto; min-height: var(--item-h);
      padding: 4px 8px;
      border: 1px solid transparent; border-radius: var(--radius);
      cursor: pointer; user-select: none;
    }
    .item:hover { background: var(--blue-05); border-color: var(--blue); }
    .item.selected { background: transparent; border-color: var(--blue); border-width: 2px; }
    .item:focus-visible { outline: 2px solid var(--blue); }

    .ic { width: 16px; height: 16px; background-size: 16px 16px; background-repeat: no-repeat; }

    .title-wrap { display: flex; flex-direction: column; min-width: 0; }
    .obj-name {
      font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .page-name {
      font-size: 11px; color: var(--muted);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* remove button */
    .remove {
      width: 16px; height: 16px; border-radius: 8px;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .remove:hover { background: var(--blue-15); }
    .remove .ic { width: 12px; height: 12px; background-size: 12px 12px; }

    /* footer: resize handle */
    .resize {
      border-top: 1px solid var(--stroke);
      padding: 8px 0; display: flex; justify-content: center; align-items: center; cursor: ns-resize;
      user-select: none;
    }
    .grip { width: 28px; height: 4px; border-radius: 2px; background: #CFCFCF; }
  </style>
</head>
<body>
  <div class="subheader">
    <div class="label">Recent</div>
    <div class="controls">
      <div id="btn-lock" class="icon-btn" role="button" tabindex="0" aria-pressed="false" title="Lock">
        <img id="lock-icon" alt="lock" width="16" height="16" />
      </div>
      <div id="btn-clear" class="icon-btn" role="button" tabindex="0" title="Clear">
        <img alt="clear" width="16" height="16" />
      </div>
    </div>
  </div>

  <div id="list" class="list" role="list" aria-label="Navigation history"></div>

  <div id="resize" class="resize" role="separator" aria-orientation="horizontal" tabindex="0">
    <div class="grip"></div>
  </div>

<script>
  // ---------- config ----------
  var CDN = 'https://owlson.github.io/FigmaJumpBack/assets/icons';
  var ICONS = {
    frame: 'frame.svg',
    page: 'page.svg',
    component: 'component.svg',
    component_set: 'component.svg',
    instance: 'instance.svg',
    group: 'group.svg',
    text: 'text.svg',
    boolean_operation: 'boolean_operation.svg',
    vector: 'vector.svg',
    rectangle: 'rectangle.svg',
    ellipse: 'ellipse.svg',
    line: 'line.svg',
    polygon: 'polygon.svg',
    star: 'star.svg',
    shape_with_text: 'shape_with_text.svg',
    autolayout: 'autolayout.svg',
    slice: 'slice.svg',
    default: 'default.svg',
    ui_clear: 'clear.svg',
    ui_lock_closed: 'lock-closed.svg',
    ui_lock_open: 'lock-open.svg',
    ui_close: 'close.svg'
  };

  // preload small UI icons
  var lockImg = document.getElementById('lock-icon');
  lockImg.src = CDN + '/' + ICONS.ui_lock_open;
  document.querySelector('#btn-clear img').src = CDN + '/' + ICONS.ui_clear;

  // ---------- state ----------
  var navHistory = []; // избегаем конфликта с window.history
  var isLocked = false;

  // ---------- helpers ----------
  function iconUrl(name) {
    var file = ICONS[name] || ICONS.default;
    return CDN + '/' + file;
  }
  function post(msg) { parent.postMessage({ pluginMessage: msg }, '*'); }
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  function getClosest(el, className) {
    // fallback для окружений без Element.closest
    if (el.closest) return el.closest('.' + className);
    while (el && el !== document.body) {
      if (el.classList && el.classList.contains(className)) return el;
      el = el.parentNode;
    }
    return null;
  }

  // ---------- render ----------
  function render() {
    var list = document.getElementById('list');
    list.innerHTML = '';
    for (var i = 0; i < navHistory.length; i++) {
      var e = navHistory[i];

      var item = document.createElement('div');
      item.className = 'item' + (i === 0 ? ' selected' : '');
      item.setAttribute('role', 'button');
      item.setAttribute('tabindex', '0');
      item.setAttribute('data-index', String(i));

      var ic = document.createElement('span');
      ic.className = 'ic';
      ic.style.backgroundImage = "url('" + iconUrl(e.icon) + "')";

      var titleWrap = document.createElement('div');
      titleWrap.className = 'title-wrap';

      var objName = document.createElement('div');
      objName.className = 'obj-name';
      objName.textContent = e.nodeName || e.nodeId;
      objName.title = e.nodeName || e.nodeId;

      var pageName = document.createElement('div');
      pageName.className = 'page-name';
      pageName.textContent = e.pageName || '';
      pageName.title = e.pageName || '';

      titleWrap.appendChild(objName);
      titleWrap.appendChild(pageName);

      var rm = document.createElement('div');
      rm.className = 'remove';
      rm.setAttribute('role', 'button');
      rm.setAttribute('tabindex', '0');
      rm.setAttribute('aria-label', 'Remove from history');
      var rmIc = document.createElement('span');
      rmIc.className = 'ic';
      rmIc.style.backgroundImage = "url('" + iconUrl('ui_close') + "')";
      rm.appendChild(rmIc);

      item.appendChild(ic);
      item.appendChild(titleWrap);
      item.appendChild(rm);
      list.appendChild(item);
    }
  }

  // ---------- UI events ----------
  document.getElementById('list').addEventListener('click', function(e) {
    var removeBtn = getClosest(e.target, 'remove');
    var item = getClosest(e.target, 'item');
    if (!item) return;
    var index = Number(item.getAttribute('data-index') || 0);
    if (removeBtn) { post({ type: 'remove-entry', index: index }); return; }
    post({ type: 'navigate', entry: navHistory[index] });
  });

  document.getElementById('list').addEventListener('keydown', function(e) {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    var removeBtn = getClosest(e.target, 'remove');
    var item = getClosest(e.target, 'item');
    if (!item) return;
    var index = Number(item.getAttribute('data-index') || 0);
    e.preventDefault();
    if (removeBtn) { post({ type: 'remove-entry', index: index }); }
    else { post({ type: 'navigate', entry: navHistory[index] }); }
  });

  // lock / clear
  var btnLock = document.getElementById('btn-lock');
  btnLock.addEventListener('click', function() { post({ type: 'toggle-lock' }); });
  btnLock.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); post({ type: 'toggle-lock' }); } });

  var btnClear = document.getElementById('btn-clear');
  btnClear.addEventListener('click', function() { post({ type: 'clear-history' }); });
  btnClear.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); post({ type: 'clear-history' }); } });

  // --- vertical resize (mouse + keyboard) ---
  var resizeEl = document.getElementById('resize');
  var resizing = false;
  var startY = 0;
  var startH = 0;

  function onMouseMove(e) {
    if (!resizing) return;
    var dy = e.clientY - startY;
    var nextH = Math.max(240, startH + dy);
    parent.postMessage({ pluginMessage: { type: 'resize', height: nextH } }, '*');
  }
  function endResize() {
    if (!resizing) return;
    resizing = false;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', endResize);
  }
  resizeEl.addEventListener('mousedown', function(e) {
    resizing = true;
    startY = e.clientY;
    startH = document.documentElement.clientHeight;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', endResize);
  });
  // keyboard resize (PageUp/PageDown, шаг 40px)
  resizeEl.addEventListener('keydown', function(e) {
    if (e.key !== 'PageDown' && e.key !== 'PageUp') return;
    e.preventDefault();
    var delta = e.key === 'PageDown' ? -40 : 40;
    var nextH = Math.max(240, document.documentElement.clientHeight + delta);
    parent.postMessage({ pluginMessage: { type: 'resize', height: nextH } }, '*');
  });

  // ---------- messages from main ----------
  onmessage = function(event) {
    var msg = event.data && event.data.pluginMessage;
    if (!msg) return;

    if (msg.type === 'history') {
      navHistory = Array.isArray(msg.history) ? msg.history : [];
      render();
    }
    if (msg.type === 'lock') {
      isLocked = !!msg.locked;
      btnLock.setAttribute('aria-pressed', String(isLocked));
      lockImg.src = isLocked ? (CDN + '/' + ICONS.ui_lock_closed) : (CDN + '/' + ICONS.ui_lock_open);
      btnLock.title = isLocked ? 'Unlock' : 'Lock';
    }
  };

  // tell main we're ready
  post({ type: 'ready' });
</script>
</body>
</html>
